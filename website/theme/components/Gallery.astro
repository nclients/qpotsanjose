---
import { getImagesFromFolders } from "../utils/readImages";
import { cn } from "../utils/cn";

const { section } = Astro.props;
const images = getImagesFromFolders("/public/" + section?.folderPath);
---

<section
  id={`${section?.id || ""}`}
  class={cn(section?.noMarginTop ? "pt-0" : "pt-16 sm:pt-24 md:pt-32")}
>
  {
    section?.mode === 1 && (
      <div style={`background-color:${section?.bgColor}`}>
        <div class="mx-auto max-w-7xl px-6 lg:px-8">
          <div class="mx-auto max-w-2xl">
            <h2 class="text-3xl font-bold  text-gray-900 sm:text-4xl text-center">
              {section?.title?.map((line: string, index: number) => (
                <Fragment key={index}>
                  <span class="block leading-16">{line}</span>
                </Fragment>
              ))}
            </h2>

            {section?.description?.map((info: string, index: number) => (
              <Fragment key={index}>
                <p class="mt-4 text-lg leading-8 text-gray-600 text-center">
                  {info}
                </p>
              </Fragment>
            ))}
          </div>

          <div class="mx-auto mt-16 grid max-w-2xl auto-rows-fr grid-cols-1 gap-16 sm:mt-20 lg:mx-0 lg:max-w-none text-center">
            {images?.map((item, index) => (
              <Fragment key={index}>
                <div>
                  <div class="relative isolate flex flex-col justify-end overflow-hidden rounded-2xl bg-gray-900">
                    <img
                      src={item?.src?.replace("/public", "")}
                      alt={item?.name}
                      class="w-full object-contain cursor-pointer"
                      loading="lazy"
                      data-src={item?.src}
                      tabindex="0"
                    />
                  </div>
                  {section?.showImgName ? (
                    <div
                      class="mt-3 text-lg leading-6 text-shadow-all shadow-gray-100"
                      style={`color: ${section?.imgNameColor}`}
                    >
                      <span class="text-center">
                        <span class="absolute inset-0" />
                        {item?.name.split("__").map((part, subIndex) => (
                          <Fragment key={subIndex}>
                            {part
                              ?.replace(/_/g, " ")
                              ?.replace(/w:/g, "w/")
                              ?.replace(/w:o/g, "w/o")}
                            <br />
                            <br />
                          </Fragment>
                        ))}
                      </span>
                    </div>
                  ) : (
                    ""
                  )}
                </div>
              </Fragment>
            ))}
          </div>
        </div>
      </div>
    )
  }

  {
    section?.mode === 2 && (
      <div style={`background-color:${section?.bgColor}`}>
        <div class="mx-auto max-w-7xl px-6 lg:px-8">
          <div class="mx-auto max-w-2xl">
            <h2 class="text-3xl font-bold  text-gray-900 sm:text-4xl text-center">
              {section?.title?.map((line: string, index: number) => (
                <Fragment key={index}>
                  <span class="block leading-16">{line}</span>
                </Fragment>
              ))}
            </h2>

            {section?.description?.map((info: string, index: number) => (
              <Fragment key={index}>
                <p class="mt-4 text-lg leading-8 text-gray-600 text-center">
                  {info}
                </p>
              </Fragment>
            ))}
          </div>
          <div class="mx-auto mt-16 grid max-w-2xl auto-rows-fr grid-cols-1 sm:grid-cols-2 gap-16 sm:mt-20 lg:mx-0 lg:max-w-none text-center">
            {images?.map((item, index) => (
              <Fragment key={index}>
                <div>
                  <div class="relative isolate flex flex-col justify-end overflow-hidden rounded-2xl bg-gray-900">
                    <img
                      src={item?.src?.replace("/public", "")}
                      alt={item?.name}
                      class="w-full object-contain cursor-pointer"
                      loading="lazy"
                      data-src={item?.src}
                      tabindex="0"
                    />
                  </div>
                  {section?.showImgName ? (
                    <div
                      class="mt-3 text-lg leading-6 text-shadow-all shadow-gray-100"
                      style={`color: ${section?.imgNameColor}`}
                    >
                      <span class="text-center">
                        <span class="absolute inset-0" />
                        {item?.name.split("__").map((part, subIndex) => (
                          <Fragment key={subIndex}>
                            {part
                              ?.replace(/_/g, " ")
                              ?.replace(/w:/g, "w/")
                              ?.replace(/w:o/g, "w/o")}
                            <br />
                            <br />
                          </Fragment>
                        ))}
                      </span>
                    </div>
                  ) : (
                    ""
                  )}
                </div>
              </Fragment>
            ))}
          </div>
        </div>
      </div>
    )
  }
  {
    section?.mode === 3 && (
      <div style={`background-color:${section?.bgColor}`}>
        <div class="mx-auto max-w-7xl px-6 lg:px-8">
          <div class="flex flex-col justify-center items-center mx-auto max-w-2xl">
            <h2 class="text-3xl font-bold  text-gray-900 sm:text-4xl text-center">
              {section?.title?.map((line: string, index: number) => (
                <Fragment key={index}>
                  <span class="block leading-16">{line}</span>
                </Fragment>
              ))}
            </h2>

            {section?.description?.map((info: string, index: number) => (
              <Fragment key={index}>
                <p class="mt-4 text-lg leading-8 text-gray-600 text-center">
                  {info}
                </p>
              </Fragment>
            ))}
          </div>
          <ul
            role="list"
            class="mx-auto mt-8 grid max-w-2xl grid-cols-1 gap-x-8 gap-y-14 sm:grid-cols-2 lg:mx-0 lg:max-w-none lg:grid-cols-3 xl:grid-cols-3"
          >
            {images?.map((item, index) => (
              <Fragment key={index}>
                <li>
                  <img
                    src={item?.src?.replace("/public", "")}
                    alt={item?.name}
                    class={`aspect-[14/13] w-full rounded-2xl object-cover rounded-${section?.menuItemImgRounded} hover:scale-105 duration-300 object-contain cursor-pointer`}
                    loading="lazy"
                    data-src={item?.src}
                    tabindex="0"
                  />
                  {section?.showImgName ? (
                    <div
                      class="mt-6 text-lg leading-8  text-center"
                      style={`color: ${section?.imgNameColor}`}
                    >
                      {item?.name.split("__").map((part) => (
                        <span>
                          {part
                            ?.replace(/_/g, " ")
                            ?.replace(/w:/g, "w/")
                            ?.replace(/w:o/g, "w/o")}
                          <br />
                        </span>
                      ))}
                    </div>
                  ) : (
                    ""
                  )}
                </li>
              </Fragment>
            ))}
          </ul>
        </div>
      </div>
    )
  }

  {
    section?.mode === 4 && (
      <div style={`background-color:${section?.bgColor}`}>
        <div class="mx-auto max-w-7xl px-6 lg:px-8">
          <div class="flex flex-col justify-center items-center mx-auto max-w-2xl">
            <h2 class="text-3xl font-bold  text-gray-900 sm:text-4xl text-center">
              {section?.title?.map((line: string, index: number) => (
                <Fragment key={index}>
                  <span class="block leading-16">{line}</span>
                </Fragment>
              ))}
            </h2>

            {section?.description?.map((info: string, index: number) => (
              <Fragment key={index}>
                <p class="mt-4 text-lg leading-8 text-gray-600 text-center">
                  {info}
                </p>
              </Fragment>
            ))}
          </div>
          <ul
            role="list"
            class="mx-auto mt-8 grid max-w-2xl grid-cols-1 gap-x-8 gap-y-14 sm:grid-cols-2 lg:mx-0 lg:max-w-none lg:grid-cols-3 xl:grid-cols-4"
          >
            {images?.map((item, index) => (
              <Fragment key={index}>
                <li>
                  <img
                    src={item?.src?.replace("/public", "")}
                    alt={item?.name}
                    class={`aspect-[14/13] w-full rounded-2xl object-cover rounded-${section?.menuItemImgRounded} hover:scale-105 duration-300 object-contain cursor-pointer`}
                    loading="lazy"
                    data-src={item?.src}
                    tabindex="0"
                  />
                  {section?.showImgName ? (
                    <div
                      class="mt-6 text-lg leading-8  text-center"
                      style={`color: ${section?.imgNameColor}`}
                    >
                      {item?.name.split("__").map((part) => (
                        <span>
                          {part
                            ?.replace(/_/g, " ")
                            ?.replace(/w:/g, "w/")
                            ?.replace(/w:o/g, "w/o")}
                          <br />
                        </span>
                      ))}
                    </div>
                  ) : (
                    ""
                  )}
                </li>
              </Fragment>
            ))}
          </ul>
        </div>
      </div>
    )
  }

  {
    section?.mode === 5 && (
      <div style={`background-color:${section?.bgColor}`}>
        <div class="mx-auto max-w-7xl px-6 lg:px-8">
          <div class="flex flex-col justify-center items-center mx-auto max-w-2xl">
            <h2 class="text-3xl font-bold text-gray-900 sm:text-4xl text-center">
              {section?.title?.map((line: string, index: number) => (
                <Fragment key={index}>
                  <span class="block leading-16">{line}</span>
                </Fragment>
              ))}
            </h2>

            {section?.description?.map((info: string, index: number) => (
              <Fragment key={index}>
                <p class="mt-4 text-lg leading-8 text-gray-600 text-center">
                  {info}
                </p>
              </Fragment>
            ))}
          </div>

          <div
            class="mx-auto mt-8 max-w-5xl md:hidden"
            data-gallery-carousel
            data-autoplay-interval="3500"
          >
            {images?.length ? (
              <>
                <div class="rounded-2xl bg-gray-100 p-2 sm:p-3">
                  <img
                    src={images[0]?.src?.replace("/public", "")}
                    alt={images[0]?.name}
                    class={`w-full aspect-[16/10] rounded-2xl object-cover rounded-${section?.menuItemImgRounded}`}
                    data-carousel-main-image
                    loading="eager"
                  />
                </div>

                {section?.showImgName ? (
                  <div
                    class="mt-4 text-lg leading-7 text-center"
                    style={`color: ${section?.imgNameColor}`}
                    data-carousel-main-name
                  >
                    {images[0]?.name
                      .replace(/_/g, " ")
                      .replace(/w:/g, "w/")
                      .replace(/w:o/g, "w/o")}
                  </div>
                ) : (
                  ""
                )}

                <div class="mt-4 overflow-x-auto pb-1">
                  <div
                    class="flex min-w-max items-center gap-3"
                    data-carousel-thumbnails
                  >
                    {images?.map((item, index) => (
                      <button
                        type="button"
                        class={`relative shrink-0 rounded-xl border-2 transition ${
                          index === 0
                            ? "border-gray-900"
                            : "border-transparent hover:border-gray-400"
                        }`}
                        data-carousel-thumb
                        data-index={index}
                        data-src={item?.src?.replace("/public", "")}
                        data-alt={item?.name}
                        data-name={item?.name
                          .replace(/_/g, " ")
                          .replace(/w:/g, "w/")
                          .replace(/w:o/g, "w/o")}
                        aria-label={`Show image ${index + 1}`}
                      >
                        <img
                          src={item?.src?.replace("/public", "")}
                          alt={item?.name}
                          class={`h-20 w-28 rounded-xl object-cover rounded-${section?.menuItemImgRounded}`}
                          loading="lazy"
                        />
                      </button>
                    ))}
                  </div>
                </div>
              </>
            ) : (
              <p class="text-center text-gray-500">No images found.</p>
            )}
          </div>

          <ul
            role="list"
            class="mx-auto mt-8 hidden max-w-2xl grid-cols-1 gap-x-8 gap-y-14 sm:grid-cols-2 md:grid lg:mx-0 lg:max-w-none lg:grid-cols-3 xl:grid-cols-4"
            data-gallery-desktop
            data-visible-count="12"
          >
            {images?.map((item, index) => (
              <Fragment key={index}>
                <li
                  data-gallery-desktop-item
                  class={index >= 12 ? "hidden" : ""}
                >
                  <img
                    src={item?.src?.replace("/public", "")}
                    alt={item?.name}
                    class={`aspect-[14/13] w-full rounded-2xl object-cover rounded-${section?.menuItemImgRounded} hover:scale-105 duration-300 object-contain cursor-pointer`}
                    loading="lazy"
                    data-src={item?.src}
                    tabindex="0"
                  />
                  {section?.showImgName ? (
                    <div
                      class="mt-6 text-lg leading-8 text-center"
                      style={`color: ${section?.imgNameColor}`}
                    >
                      {item?.name.split("__").map((part) => (
                        <span>
                          {part
                            ?.replace(/_/g, " ")
                            ?.replace(/w:/g, "w/")
                            ?.replace(/w:o/g, "w/o")}
                          <br />
                        </span>
                      ))}
                    </div>
                  ) : (
                    ""
                  )}
                </li>
              </Fragment>
            ))}
          </ul>
          {images?.length > 12 && (
            <div class="mt-6 hidden justify-center md:flex">
              <button
                type="button"
                class="rounded-md border border-gray-300 px-5 py-2 text-sm font-semibold hover:bg-gray-100"
                data-gallery-more-btn
              >
                View More
              </button>
            </div>
          )}
        </div>
      </div>
    )
  }
</section>

<script>
  const carousels = document.querySelectorAll("[data-gallery-carousel]");

  carousels.forEach((carousel) => {
    const mainImage = carousel.querySelector("[data-carousel-main-image]");
    const mainName = carousel.querySelector("[data-carousel-main-name]");
    const thumbsContainer = carousel.querySelector("[data-carousel-thumbnails]");
    const thumbsScroller = thumbsContainer?.parentElement;
    const thumbs = Array.from(carousel.querySelectorAll("[data-carousel-thumb]"));
    const intervalMs = Number(carousel.getAttribute("data-autoplay-interval")) || 3500;

    if (!mainImage || thumbs.length === 0) return;

    let activeIndex = 0;
    let timer: number | null = null;

    const setActive = (nextIndex: number) => {
      activeIndex = (nextIndex + thumbs.length) % thumbs.length;

      thumbs.forEach((thumb, index) => {
        if (index === activeIndex) {
          thumb.classList.add("border-gray-900");
          thumb.classList.remove("border-transparent", "hover:border-gray-400");
        } else {
          thumb.classList.remove("border-gray-900");
          thumb.classList.add("border-transparent", "hover:border-gray-400");
        }
      });

      const activeThumb = thumbs[activeIndex];
      const nextSrc = activeThumb.getAttribute("data-src");
      const nextAlt = activeThumb.getAttribute("data-alt") || "";
      const nextName = activeThumb.getAttribute("data-name") || "";

      if (nextSrc) mainImage.setAttribute("src", nextSrc);
      mainImage.setAttribute("alt", nextAlt);
      if (mainName) mainName.textContent = nextName;
      if (
        thumbsContainer &&
        thumbsScroller instanceof HTMLElement &&
        activeThumb instanceof HTMLElement
      ) {
        const targetLeft =
          activeThumb.offsetLeft - (thumbsScroller.clientWidth - activeThumb.clientWidth) / 2;
        const maxLeft = thumbsScroller.scrollWidth - thumbsScroller.clientWidth;
        const nextLeft = Math.max(0, Math.min(targetLeft, Math.max(0, maxLeft)));

        thumbsScroller.scrollTo({
          left: nextLeft,
          behavior: "smooth",
        });
      }

    };

    const start = () => {
      timer = window.setInterval(() => {
        setActive(activeIndex + 1);
      }, intervalMs);
    };

    const stop = () => {
      if (timer !== null) window.clearInterval(timer);
    };

    thumbs.forEach((thumb, index) => {
      thumb.addEventListener("click", () => {
        setActive(index);
      });
    });

    carousel.addEventListener("mouseenter", stop);
    carousel.addEventListener("mouseleave", start);

    setActive(0);
    start();
  });

  const desktopGalleries = document.querySelectorAll("[data-gallery-desktop]");
  desktopGalleries.forEach((gallery) => {
    const items = Array.from(gallery.querySelectorAll("[data-gallery-desktop-item]"));
    const visibleCount = Number(gallery.getAttribute("data-visible-count")) || 12;
    const moreBtn = gallery.parentElement?.querySelector("[data-gallery-more-btn]");

    if (items.length <= visibleCount || !moreBtn) return;

    moreBtn.addEventListener("click", () => {
      items.forEach((item) => item.classList.remove("hidden"));
      moreBtn.classList.add("hidden");
    });
  });
</script>
